{% extends "partials/base.html" %}
{% load static %}

{% block title %}
{{ user }}'s cart
{% endblock %}

{% block content %}
<div class="main">
    <!-- Breadcrumb -->
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Shop
                <span></span> Shipping Address
                <span></span> Checkout
            </div>
        </div>
    </div>

    <!-- Checkout Section -->
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row d-flex justify-content-between">
                <!-- Address Selection -->
                <div class="col-md-5">
                    <!-- Checkout Panel Information -->
                    <form id="paymentForm" method="post" action="{% url 'order:payment' %}">
                        <h4>Create new address</h4>
                        <span><a href="{% url 'order:create_address' %}" id="createAddressLink"><u>click here to create address</u></a></span>
                         <br>
                        {% csrf_token %}
                        {% if addresses %}
                        <div class="row">
                            <!-- Saved Addresses -->
                            {% for add in addresses %}
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-group form-check-custom form-radio-custom form-radio-highlight mb-3">
                                            <span class="d-flex justify-content-between align-items-start">
                                                <span class="col-7">
                                                    <h5 class="mb-0 fw-bolder d-block text-secondary">{{ add.name }}</h5>
                                                    <span class="small fw-bolder text-uppercase">{{ add.phone }}</span><br>
                                                    <span class="small fw-bolder text-uppercase">{{ add.address_line_1 }},  {{ add.address_line_2 }}</span><br>
                                                    <span class="small fw-bolder text-uppercase">{{ add.city }}  {{ add.state }}</span><br>
                                                    <span class="fw-bolder">pin: {{ add.pincode }}</span> 
                                                </span>
                                                <span class="col-4">
                                                    <!-- Set width to 30% -->
                                                    <style>
                                                        .custom-radio {
                                                            border: 1px solid black;
                                                            background-color: transparent;
                                                            color: black;
                                                            width: 30px;
                                                            height: 30px;
                                                            border-radius: 50%;
                                                            display: flex;
                                                            align-items: center;
                                                            justify-content: center;
                                                            cursor: pointer;
                                                            transition: background-color 0.3s, color 0.3s;
                                                        }
                                                        .custom-radio:hover {
                                                            background-color: black;
                                                            color: #ffff;
                                                        }
                                                        .custom-radio input[type="radio"] {
                                                            display: none;
                                                        }
                                                        .custom-radio input[type="radio"]:checked + .checkmark {
                                                            background-color: green; /* Change to green when selected */
                                                        }
                                                        .checkmark {
                                                            display: inline-block;
                                                            width: 15px;
                                                            height: 15px;
                                                            border-radius: 50%;
                                                            background-color: transparent;
                                                        }
                                                    </style>
                                                    <label class="custom-radio">
                                                        <input type="radio" name="selected_address" value="{{ add.id }}">
                                                        <span class="checkmark"></span>
                                                    </label>
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {%else%}
                                                                                 
                           
                
                        <h3 class="fs-5 mt-5 mb-4 border-bottom pb-4">
         
                        create your address to continue shopping 
                        <br>
                         <span><a href="{% url 'order:create_address' %}" id="createAddressLink"><u>click here to create address</u></a></span>
                     
                     </h3>
               
               
                         {% endif %}
                     
                    </form>
                </div>

                <!-- Product Details -->
                <div class="col-md-6 create-address-column">
                    <!-- Product Table -->
                    <h3 class="fs-5 mt-5 mb-4 border-bottom pb-4">Product Details</h3>
                    <div class="row">
                        <div class="col-md-12">
                            <!-- Product Table -->
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Image</th>
                                            <th scope="col">Name</th>
                                            <th scope="col">Price</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Subtotal</th>
                                            <th scope="col">Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cart_item in cart_items %}
                                        <tr>
                                            <td class="image product-thumbnail"><img src="{{ cart_item.product.image.url }}" alt="{{ cart_item.product.name }}"></td>
                                            <td class="product-des product-name">
                                                <h5 class="product-name"><a href="#">{{ cart_item.product.name }}</a></h5>
                                            </td>
                                            <td class="price" data-title="Price">
                                                {% if cart_item.product.discounted_price %}
                                                    <span>{{ cart_item.product.discounted_price }}</span>
                                                {% else %}
                                                    <span>{{ cart_item.product.price }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center" data-title="Quantity">
                                                <div class="detail-qty border radius m-auto">
                                                    <a href="{% url 'cart:add_cart' cart_item.product.id %}" class="qty-up"></a>
                                                    <span class="qty-val">{{ cart_item.quantity }}</span>
                                                    <a href="{% url 'cart:remove_cart' cart_item.product.id %}" class="qty-down"></a>
                                                </div>
                                            </td>
                                            <td class="price" data-title="Price">
                                                {% if cart_item.product.discounted_price %}
                                                    <span>{{ cart_item.product.discounted_price }}</span>
                                                {% else %}
                                                    <span>{{ cart_item.product.price }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="action" data-title="Remove">
                                                <a href="{% url 'cart:remove_cart_item' cart_item.product.id %}" class="text-muted"><i class="fi-rs-trash"></i></a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Order Summary -->
                    <div class="border p-md-4 p-30 border-radius cart-totals">
                        <div class="heading_s1 mb-3">
                            <h4>Review Orders</h4>
                        </div>
                        <div class="table-responsive">
                            <table class="table shopping-summery text-center clean">
                                <tbody>
                                    <tr>
                                        <td class="cart_total_label">Cart Subtotal</td>
                                        <td class="cart_total_amount"><span class="font-lg fw-900 text-brand">{{total}}</span></td>
                                    </tr>
                                    <tr>
                                        <td class="cart_total_label">Tax</td>
                                        <td class="cart_total_amount"><span class="font-lg fw-900 text-brand">{{tax}}</span></td>
                                    </tr>

                                    <tr>
                                        <td class="cart_total_label">Shipping</td>
                                        <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping</td>
                                    </tr>
                                    <!-- <tr>
                                        <td class="cart_total_label">Coupon Discount Percentage</td>
                                        <td class="cart_total_amount"><span class="font-lg fw-900 text-brand" id="couponDiscountPercentage">0%</span></td>
                                    </tr> -->
                                    <tr>
                                        <td class="cart_total_label">Total</td>
                                        <td class="cart_total_amount">
                                            <strong>
                                                <span id="totalPrice" class="font-xl fw-900 text-brand">{{grand_total}}</span>
                                            </strong>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <br>
                        
                   
                        <!-- Coupon Section -->
                        <div class="row">
                            <div class="col-md-8">
                                <button id="couponBtn" class="btn btn-primary w-100">Apply Coupon</button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100 remove-coupon-btn" data-coupon-id="{{ coupon.id }}">Remove Coupon</button>
                            </div>
                        </div>
                        <br>
                        
                        <!-- Modal -->
                        <div id="couponModal" class="modal">
                            <!-- Modal content -->
                            <div class="modal-content">
                                <span class="close">&times;</span>
                                <h2>Apply Coupon</h2>
                                <form id="couponForm">
                                    <input type="text" id="couponCode" name="couponCode" placeholder="Enter coupon code" class="form-control mb-3">
                                    <button type="submit" class="btn btn-success">Apply</button>
                                </form>
                            </div>
                        </div>

                        <br>
                        <!-- Payment Method -->
                        <div class="payment_method">
                            <div class="mb-25">
                                <h5>Payment</h5>
                            </div>
                                <div class="payment_option">
                                    <div class="custome-radio">
                                        <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios3" checked="" value="COD">
                                        <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse" data-target="#cashOnDelivery" aria-controls="cashOnDelivery">Cash on Delivery</label>
                                        <div class="form-group collapse in" id="cashOnDelivery">
                                            {% if messages %}
                                                {% for message in messages %}
                                                    <div class="alert alert-{{ message.tags }}" role="alert">
                                                        {{ message }}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                            <p class="text-muted mt-5">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration. </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="custome-radio">
                                    <input class="form-check-input" required="" type="radio" name="payment_option" id="razorpayOption" value="Razor-Pay">
                                    <label class="form-check-label" for="razorpayOption" data-bs-toggle="collapse" data-target="#razorpay" aria-controls="razorpay"><strong class="text-dark">Razorpay Online Payment</strong></label>
                                    <div class="form-group collapse" id="razorpay">
                                        <!-- Razorpay payment form goes here -->
                                        <!-- Example: -->
                                    </div>
                                </div>
                                
                            </div>
                            
    
                            <!-- Place Order Button -->
                            <button id="rzp-button1" type="submit" name="submit" class="btn btn-block" disabled>Place Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- End of Checkout Section -->
    </div>
    
      
            </section>
            <!--================== checkout =====================-->
        </main>
        <!-- JavaScript to enable/disable the button -->
        

<script>
    // Function to check if an address is selected
    function checkAddressSelected() {
        // Get the selected address radio buttons
        var selectedAddressRadioButtons = document.querySelectorAll('input[name="selected_address"]');
        // Loop through each radio button

        for (var i = 0; i < selectedAddressRadioButtons.length; i++) {
            // If any radio button is checked, enable the Place Order button and return
            if (selectedAddressRadioButtons[i].checked) {
                document.getElementById('rzp-button1').disabled = false;
                return;
            }
        }
        // If no address is selected, disable the Place Order button
        document.getElementById('rzp-button1').disabled = true;
    }

    // Call the function initially
    checkAddressSelected();

    // Attach an event listener to the address radio buttons to call the function when they change
    var addressRadioButtons = document.querySelectorAll('input[name="selected_address"]');
    addressRadioButtons.forEach(function(radioButton) {
        radioButton.addEventListener('change', checkAddressSelected);
    });
</script>
        <!--===================--> 

    

<script src="https://checkout.razorpay.com/v1/checkout.js">

</script>
<script>
     
    // Function to retrieve the CSRF token from the cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    
    console.log("selectedPaymhhhhhhhhhhhhhentMethod");
    const url = window.location.origin
    document.getElementById('rzp-button1').addEventListener('click', function(e) {
        var selectedAddress = document.querySelector('input[name="selected_address"]:checked').value;
        var selectedPaymentMethod = document.querySelector('input[name="payment_option"]:checked').value;
        var walletCheckbox = document.getElementById('walletCheckbox');
        console.log("pppppppppppp",selectedPaymentMethod);
        console.log("aaaaaaaaaaa",selectedAddress);
        console.log("Selected payment method:", selectedPaymentMethod);

        
        if (selectedPaymentMethod === 'Razor-Pay') {
            // Handle Razorpay payment
            e.preventDefault();
            console.log('llllllllllllllllllllllllllll');

            fetch('/checkout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({
                    selected_payment_method: selectedPaymentMethod,
                    selected_address: selectedAddress,
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);

                const paymentOrderId = data.context.payment_order_id;
                const paymentAmount = data.context.amount;
                console.log('Payment information:', paymentOrderId);

                var razorpayKeyId = "rzp_test_fGwLaAdAhjOjbm";
                console.log(razorpayKeyId);
                console.log(paymentAmount);
                console.log(paymentOrderId);
               
                var options = {
                    "key": razorpayKeyId,
                    "amount": paymentAmount,
                    "name": "PetEase",
                    "image": "{%static  'assets/imgs/banner/pupease-high-resolution-logo-transparent (1).png'%}",
                    "order_id":paymentOrderId,
                    "callback_url":`${url}/paymenthandler/`,
                    "prefill": {
                        "name": "{{ request.user.username }}",
                        "email": "{{ request.user.email }}",
                        "contact": "{{ request.user.phone_number }}"
                    },
                    "theme": {
                        "color": "#b19361"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function(response) {
                    alert(response.error.code);
                });

                rzp1.open();
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        } else{

                    // Handle other payment methods
            e.preventDefault(); // Prevent default form submission


        fetch('/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                selected_payment_method: selectedPaymentMethod,
                selected_address: selectedAddress,
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Handle response data if needed
            console.log('Received data:', data);
            // You can handle redirects or further processing here
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });

    //         console.log('hhhhhhhhhhhhhhhhh');

    // Redirect to the payment view for other payment methods
    var paymentForm = document.getElementById('paymentForm');
    paymentForm.action = `${url}/payment/`; // Replace 'order:payment' with the actual URL name of your payment view
    paymentForm.submit();
}
    });
///////////////////////////////////////////coupon/////////////////////////////////////////////////////////////
// Get the modal
var modal = document.getElementById("couponModal");

// Get the button that opens the modal
var btn = document.getElementById("couponBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
// Handle form submission
document.getElementById("couponForm").addEventListener("submit", function(event) {
  event.preventDefault(); // Prevent form submission
  
  var couponCode = document.getElementById("couponCode").value;
  console.log("Coupon Code:", couponCode);
  
  // Send AJAX request to server to validate coupon code
  fetch('/apply_coupon/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken,
    },
    body: JSON.stringify({ coupon_code: couponCode }),
  })
  
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    // Check if the coupon is valid
    if (data.success) {
        // Update total price if coupon is valid
        var newTotalPrice = data.new_total_price;
        var discountPercentage = data.discount_percentage;
        updateTotal(newTotalPrice,discountPercentage);
        console.log("Coupon applied successfully!");
    } else {
        // Display error message if coupon is invalid
        console.error("Invalid coupon code:", data.message);
    }
})
  .catch(error => {
    console.error('There was a problem with the fetch operation:', error);
  });
});

// Function to update total price after applying coupon
function updateTotal(newTotal,discountPercentage) {
    var totalElement = document.getElementById('totalPrice');
    if (totalElement) {
        // Ensure newTotal is parsed as a number before using toFixed
        var formattedTotal = parseFloat(newTotal).toFixed(2);
        totalElement.innerText = formattedTotal;
    } else {
        console.error('Total element not found in the DOM');
    }
    // Update coupon discount display
    var discountPercentageElement = document.getElementById('discountPercentage');
        if (discountPercentageElement) {
            discountPercentageElement.innerText = discountPercentage + '%';
        } else {
            console.error('Discount percentage element not found in the DOM');
        }
}





// Add an event listener to the Remove Coupon button
document.querySelector('.remove-coupon-btn').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default form submission
    
    // Send AJAX request to remove the coupon
    fetch('/remove_coupon/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Check if the coupon was successfully removed
        if (data.success) {
            // Update the total price with the new total from the response
            updateTotal(data.new_total);
            console.log("Coupon removed successfully!");
        } else {
            console.error("Failed to remove coupon:", data.message);
        }
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });
     // Reset coupon discount display to zero
     var couponDiscountElement = document.getElementById('couponDiscount');
    if (couponDiscountElement) {
        couponDiscountElement.innerText = '0.00';
    }
});

// Function to update total price after applying or removing coupon
function updateTotal(newTotal) {
    console.log('New Total:', newTotal); 
    var totalElement = document.getElementById('totalPrice');
    if (totalElement) {
        // Ensure newTotal is parsed as a number before using toFixed
        var formattedTotal = isNaN(newTotal) ? 'NaN' : parseFloat(newTotal).toFixed(2);
        console.log('Formatted Total:', formattedTotal);
        totalElement.innerText = formattedTotal;
    } else {
        console.error('Total element not found in the DOM');
    }
}

// Fetch available coupons and populate the select dropdown


</script>

<style>
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
        <!--========= Preloader Start ==========-->
        
        <!--========= Preloader end ==========-->

        <!--========= Vendor JS==========-->
        <script src="{% static 'assets/js/vendor/modernizr-3.6.0.min.js' %}"></script>
        <script src="{% static 'assets/js/vendor/jquery-3.6.0.min.js' %}"></script>
        <script src="{% static 'assets/js/vendor/jquery-migrate-3.3.0.min.js' %}"></script>
        <script src="{% static 'assets/js/vendor/bootstrap.bundle.min.js' %}"></script>
        <script src="{% static 'assets/js/plugins/slick.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery.syotimer.min.js' %}"></script>
        <script src="{% static 'assets/js/plugins/wow.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery-ui.js' %}"></script>
        <script src="{% static 'assets/js/plugins/perfect-scrollbar.js' %}"></script>
        <script src="{% static 'assets/js/plugins/magnific-popup.js' %}"></script>
        <script src="{% static 'assets/js/plugins/select2.min.js' %}"></script>
        <script src="{% static 'assets/js/plugins/waypoints.js' %}"></script>
        <script src="{% static 'assets/js/plugins/counterup.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery.countdown.min.js' %}"></script>
        <script src="{% static 'assets/js/plugins/images-loaded.js' %}"></script>
        <script src="{% static 'assets/js/plugins/isotope.js' %}"></script>
        <script src="{% static 'assets/js/plugins/scrollup.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery.vticker-min.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery.theia.sticky.js' %}"></script>
        <script src="{% static 'assets/js/plugins/jquery.elevatezoom.js' %}"></script>
        <!--===================-->

     {% endblock content %}